import {DocsImage} from "../../../components/docs/Image";
import immutablePlate from "../../../../public/images/docs/immutablePlate.png"

# ⛔ 이슈 8 : 노트 에디터 상태관리 충돌


### 📝 상황 설명

- `Plate.js`를 기반으로 한 노트 에디터에서 **복사/붙여넣기 기능이 정상적으로 동작하지 않는 문제**가 발생함.
- `selectedNoteState`라는 상위 상태와 에디터 상태가 연결된 상태에서 **블록 요소 복사(duplicate) 시 실패**하는 현상이 발견됨.
- 상태 연결을 끊으면 복사 기능은 정상 작동했으나, **서버 동기화가 이루어지지 않음**.
- 에러 메시지 없이 기능이 조용히 실패하여 디버깅이 어려운 상황이었음.

---

### 🔍 원인 분석

1. **불변성 관리 충돌 (`immer` vs `Plate.js`)**
    <div className="mt-6">
      <DocsImage src={immutablePlate} alt="immutablePlate"/>
    </div>
    - [`Plate.js` 내부에서는 **불변성을 강제하는 방식**으로 상태를 변경함](https://platejs.org/docs/api/core/plate-controller#dealing-with-fallback-editors)
    - 하지만, 에디터를 도입하기 전의 프로젝트는 `immer.js`를 사용하여 `selectedNoteState`를 관리하고 있었고, 두 방식이 충돌을 일으킴.
    - 이로 인해 **에디터 내부 상태 업데이트가 막혀 복사/붙여넣기가 작동하지 않음**.

2. **Plate.js의 상태 변화 방식과의 불일치**
    - `Plate.js`는 내부적으로 **자체적인 상태를 유지하며 변화를 감지**하는 구조.
    - `immer`를 통한 전역 상태 업데이트가 **Plate.js의 내부 상태 변화 방식과 충돌**하여 기능이 정상적으로 동작하지 않음.

3. **상위 상태 업데이트 방식 문제**
    - `immer`는 `produce`를 사용해 상태 변경을 감지하지만, 에디터에서 데이터가 변경될 때마다 **immer의 상태 변경 감지가 예상대로 이루어지지 않음**.
    - `selectedNoteState`가 예상과 다르게 업데이트되면서, 복사/붙여넣기가 비정상적으로 동작하는 원인이 됨.

---

### 🛠️ 해결 방안

1. **에디터 상태를 직접 업데이트하는 방식으로 변경**
    - 기존에는 `immer`를 통해 상태를 업데이트했지만, **직접 상태를 변경하도록 수정**.
    - 즉, 에디터 상태를 `useState`에서 관리하고 **필요할 때만 상위 상태(`selectedNoteState`)를 업데이트**하도록 변경.

```jsx
const handleEditorChange = (newContent) => {
  setSelectedNoteState((prev) => ({
    ...prev,
    content: newContent, // JSON 데이터를 직접 content에 저장
  }));
  setLocalPayload((prevPayload) => ({
    ...prevPayload,
    content: newContent, // 서버 동기화에 사용할 데이터 저장
  }));
  setIsInitialLoad(false);
  setIsNotSaved(true); // 자동 저장 플래그 설정
};
```

2. **`immer`를 특정 로직에서 제거하여 불변성 충돌 방지**
    - `selectedNoteState`를 **불변 객체로 유지할 필요가 없는 곳에서는 직접 변경**하도록 수정.
    - `immer`의 `produce` 없이 **새로운 객체를 생성하여 상태를 관리**.

3. **불필요한 상태 업데이트 최소화**
    - `useEffect`에서 **불필요한 리렌더링을 방지**하도록 의존성 배열을 조정.
    - 기존 코드에서는 상태가 변경될 때마다 불필요한 업데이트가 발생했으나, **필요할 때만 상위 상태를 업데이트하도록 최적화**.

---

### ✅ 결과

1. **에디터 복사/붙여넣기 기능 정상 작동**
    - `Plate.js` 내부 상태 관리 방식과의 충돌이 사라지면서 기능이 정상적으로 동작.

2. **서버와의 동기화 문제 해결**
    - `selectedNoteState`를 불변 객체로 유지할 필요가 없는 부분에서는 직접 업데이트하도록 변경하면서 동기화 문제도 해결됨.

3. **불필요한 상태 업데이트 제거로 성능 개선**
    - `immer`의 불필요한 상태 감지 비용을 줄이면서, 더 직관적인 상태 관리가 가능해짐.

---

### 💡 배운 점

1. **라이브러리 간 상태 관리 방식 차이를 이해해야 함**
    - `immer`와 `Plate.js`는 각각 **불변성을 다루는 방식이 다름**.
    - **이 둘이 충돌할 경우 예상치 못한 동작이 발생할 수 있음**.

2. **오류를 많이 경험해야한다.**
    - 라이브러리 제작자가 모든걸 떠먹여주지 못한다. 좋은 API에 더불어 문서를 저렇게 정리해준것만해도 굉장히 감사한일이다.
    - 각 분야마다 유난히 많이 사용되고 충돌하는 기술, 옵션 등이 있는데, 그런건 경험으로 익히는 수 밖에 없다.
    - 그러나 문제를 해결하고나서 뇌를 비우면 경험이 되지 못한다. 노트앱 만든김에 이런 경험은 간단하게라도 노트해야겠다.
