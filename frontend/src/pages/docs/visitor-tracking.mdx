import {DocsImage} from '../../components/docs/Image';
import dimg from "../../lib/docsImages";

# 자가 피드백을 위한 방문자 추적 기능

## 사건의 발단

이 사이트에 방문하는 사람이 있을까 알아보기 위해 기록을 남기는 기능을 만들었습니다.<br/>
"한국 IP" 를 기준으로 클라이언트당 1시간에 한 번 기록하는 간단한 로직입니다.

이 로직은 경로에 상관 없이 "처음 페이지가 로드되는 순간" 무조건 작동하게끔 설정했습니다.

그리고 지원하려는 회사에 포트폴리오를 제출하면서 결과 통지를 받을때까지 기록을 확인해보았는데....<br/>

<span className="flex text-xl font-semibold my-10">
  로그가 텅 비어 있었습니다.
</span>

<br/>

### 내가 예상하지 못한 실수가 있어서 안잡힌건가?

그래서 클라우드 플레어의 대시보드에서 관련 일자 접속 기록을 전부 확인했습니다.<br/>

<div className="flex justify-center my-10">
  <DocsImage src={dimg.tracking.logs}/>
</div>

그냥 Ahrefs, Sogou web spider 같은 **검색엔진 크롤링 봇만 찍혀 있었습니다.**

<br/>

## 피드백하기

지원한 회사들은 제가 만든 사이트를 **클릭조차 하지 않고 탈락시킨 것 같습니다.**<br/>

서류에서 포트폴리오를 클릭하게끔 흥미를 못끌어서 발생한 문제라는 피드백이 되었습니다.

그리고 문득 이런 생각이 들더군요

<span className="flex text-xl font-semibold italic my-10">
 "방문하고 탈락시키는건 어떻게 피드백하지?"
</span>

그래서 좀 더 디테일한 기록을 남겨보기로 결정했습니다.

백엔드에 유효한 데이터만을 최소한의 요청으로 진행하도록 최적화 하는 부분이 어필에도 도움이 될 것 같아 진행했습니다.

<br/>

## 개발 핵심

> "이 기능은 **데이터 흐름과 서버 책임 범위**를 명확히 구분하여 설계한 기능입니다.
> 불필요한 트래픽을 최소화하고, **백엔드의 기록 책임을 정교하게 분리**하며,
> 유효한 데이터만을 수집하도록 **입력 지점을 컨트롤**한 것이 핵심입니다."

---

### 1. 유효한 방문만 기록하기
- 프론트에서 `User-Agent` 기반 필터링 → **백엔드는 봇 요청 무시**
- 백엔드에 기록되는 건 **사람 + 의도적 방문자**뿐
- 무차별적인 POST 요청 방지 → **서버 부하 최소화**

> 어떤 데이터를 저장해야 ‘신뢰할 수 있는 기록’이 될지를 백엔드 차원에서 판단했습니다."

---

### 2. **분기 처리와 책임 분산 → 로직의 명확한 구획화**
- 일반 방문자 vs 회사 방문자 → **다른 API 처리 흐름 적용**
- `POST /visitor` → 방문 최초 기록
- `PUT /visitor` → 행동 기록(tracking) 누적
- 단일 API에 로직 몰빵하지 않고, **의도에 따라 라우트를 분리함**

> _"기능을 쪼갠 이유는 단순한 분기가 아니라,
> API의 책임과 목적을 명확히 하기 위해서였습니다."_

---

### 3. **데이터 구조 설계 및 스키마 관리**
- `visitor.tracking[]` 배열로 사용자 행동 로그 구조화
- 경로, 체류 시간, 방문 시간
- 배열 크기 제한 (`최대 100개`) → DB 문서 크기 제어
- IP 변경 이력은 `ipHistory[]`로 따로 관리 → **접속 환경 변화 추적 가능**

> _"사용자 데이터를 단일 필드에 몰아넣지 않고,
> 책임 단위별로 분리된 구조를 스키마 레벨에서 설계했습니다."_

---

### 4. **Cloudflare + Express + MongoDB 환경을 아우르는 흐름 설계**
- Cloudflare 헤더(`cf-connecting-ip`, `cf-ipcountry`) 사용
- Express.js에서 `req.headers`로 실시간 추출
- 몽고DB에 기록 + 관리자 페이지에서 정렬/조회

> _"단순한 백엔드 코드 구현을 넘어,
> 외부 인프라와의 연계까지 고려한 **통합된 추적 시스템**을 설계했습니다."_

---

## 로직 변화 : ‘기록’에서 ‘추적’으로

"입사 지원서를 통해 접속하면" 행동을 추적하는 로직을 추가했습니다.

- **특정 회사에 지원할때 `/home/:company` 링크를 줍니다.**
- 그 링크를 클릭하면, 로컬스토리지에 `"companyTraceEnabled"` 플래그가 설정됩니다.
- 그 순간부터 행동을 추적합니다:
  - **누가**
  - **무엇으로**
  - **언제**
  - **어떤 페이지를**
  - **얼마나 봤는지**

## 전략

| 단계 | 설명 |
|------|------|
| `/home/toss` 접속 | 회사 식별, 추적 활성화 |
| `/docs` 리다이렉트 | 자연스럽게 문서 페이지로 리다이렉트 |
| `checkVisitor()` | 초기 방문 정보 기록 |
| `companyTrace()` | 라우팅 이벤트가 발생할때 페이지 체류시간을 tracking 배열에 push |
| 새로고침/이탈 | `beforeunload` 이벤트로 라우팅이 아닐 경우도 안정적으로 처리 |
| 관리자 UI | 모든 정보 조회 |


## 진행 흐름

<br/>

<DocsImage src={dimg.tracking.flowchart}/>

이 기능을 활용하면 어떤 페이지가 매력적이고, 보완이 필요한 페이지는 어디인지 간접적으로 피드백이 될것이라 생각합니다.


## 백엔드적 키워드

| 키워드 | 설명 |
|--------|------|
| **데이터 유효성 관리** | 봇/비정상 유저 제거 후 유의미한 기록만 저장 |
| **API 책임 분리** | 기록용 POST, 추적용 PUT으로 구분 |
| **DB 구조화** | 행동 로그는 배열로, 접속 이력은 별도 구조로 |
| **인프라 연계** | Cloudflare → Express → MongoDB 전체 흐름 설계 |
| **트래픽 효율화** | 1시간 제한 로직, 필요 요청만 처리 |



## 백엔드 개발자로서 이 기능을 바라보며

이 기능은 단순한 방문자 추적 기능이 아닙니다.
저는 백엔드 서버 개발자로서 다음과 같은 관점에서 설계했습니다:

- **무차별 데이터 수집을 방지하고, 유의미한 정보만 저장**
- **API 책임을 명확히 분리하고, 흐름마다 최적화된 경로 제공**
- **데이터 스키마를 세분화하여 추후 조회 및 분석 효율 향상**
- **Cloudflare → Express → MongoDB로 이어지는 전체 흐름을 설계**

단순히 기록하는 것이 아니라,
**“무엇을 기록할 것인가”를 판단하는 백엔드의 책임**을 중심에 두었습니다.
