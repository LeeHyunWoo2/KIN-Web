import {DocsImage} from '../../components/docs/Image';
import dimg from "../../lib/docsImages";

# 억울해서 만든 방문자 추적 기능

## 사건의 발단

이 사이트에 방문하는 사람이 있을까 알아보기 위해 기록을 남기는 기능을 만들었습니다.<br/>
"한국 IP" 를 기준으로 클라이언트당 1시간에 한 번 기록하는 간단한 로직입니다.

이 로직은 경로에 상관 없이 "처음 페이지가 로드되는 순간" 무조건 작동하게끔 설정했습니다.

그리고 지원하려는 회사에 포트폴리오를 제출하면서 결과 통지를 받을때까지 기록을 확인해보았는데....<br/>

<span className="flex text-xl font-semibold text-rose-500 my-10">
  로그가 텅 비어 있었습니다.
</span>

<br/>

### 내가 예상하지 못한 실수가 있어서 안잡힌건가?

그래서 클라우드 플레어의 대시보드에서 관련 일자 접속 기록을 전부 확인했습니다.<br/>
<u>여기 기록 안남으면 그냥 안본거나 다름없죠.</u>

찾아본 결과


<div className="flex justify-center my-10">
  <DocsImage src={dimg.tracking.logs}/>
</div>

무작위 해킹시도 이런걸 제외하고 제대로 된 경로로 접근한 기록을 보면 이런것 뿐입니다.

네 그냥 Ahrefs, Sogou web spider 같은 **검색엔진 크롤링 봇만 찍혀 있었습니다.**

<br/>

### 회사 인터넷에서는 접근이 불가능한건가?

그래서 문의 남겼습니다.

<div className="flex justify-center my-10">
  <DocsImage src={dimg.tracking.mail}/>
</div>

접속 안되면 다시 요청을 한다네요.

아하! 그냥 접속을 안하면 재 요청할 일도 없네!

<br/>

## 이게 맞나?

지원한 회사들은 제가 만든 사이트를 **클릭조차 하지 않고 탈락시켰습니다.**<br/>
다들 굉장히 바쁘시고, 워낙 신청자가 많으니 어쩔 수 없다는건 이해합니다.<br/>

그렇다고 하더라도, **클릭 딸깍 한번 해서 빠르게 훑어는 봐야** 최소한의 예의 아닌가요?

얼마 없는 기회 잡으려고 다들 인생걸고 죽어라 노력하는건데, 보는 사람도 그에 맞게 임해야 하는거 아닙니까?

그래서 이런 생각이 들었습니다.

<span className="flex text-xl font-semibold italic text-rose-500 my-10">
 "날 평가하는 사람을 평가해야겠다."
</span>

<br/>

## 로직 변화 : ‘기록’에서 ‘추적’으로

"입사 지원서를 통해 접속하면" 행동을 추적하는 로직을 추가했습니다.

- **특정 회사에 지원할때 `/home/:company` 링크를 줍니다.**
- 그 링크를 클릭하면, 로컬스토리지에 `"companyTraceEnabled"` 플래그가 설정됩니다.
- 그 순간부터, 모든 행동을 추적합니다:
  - **누가**
  - **무엇으로**
  - **언제**
  - **어떤 페이지를**
  - **얼마나 봤는지**

## 전략

| 단계 | 설명 |
|------|------|
| `/home/toss` 접속 | 회사 식별, 추적 활성화 |
| `/docs` 리다이렉트 | 자연스럽게 문서 페이지로 리다이렉트 |
| `checkVisitor()` | 초기 방문 정보 기록 |
| `companyTrace()` | 라우팅 이벤트가 발생할때 페이지 체류시간을 tracking 배열에 push |
| 새로고침/이탈 | `beforeunload` 이벤트로 라우팅이 아닐 경우도 안정적으로 처리 |
| 관리자 UI | 모든 정보 조회 |


## 진행 흐름

<br/>

<DocsImage src={dimg.tracking.flowchart}/>

읽어주셔서 진심으로 감사드립니다.